{"name":"Jenkins","tagline":"Development repository for Jenkins Chef cookbook","body":"jenkins Cookbook\r\n================\r\n[![Build Status](http://img.shields.io/travis/opscode-cookbooks/jenkins.svg)][travis]\r\n\r\n\r\n[travis]: http://travis-ci.org/chef-cookbooks/jenkins\r\n\r\nInstalls and configures Jenkins CI master & node slaves. Resource providers to support automation via jenkins-cli, including job create/update.\r\n\r\nThis project is managed by the CHEF Release Engineering team. For more information on the Release Engineering team's contribution, triage, and release process, please consult the [CHEF Release Engineering OSS Management Guide](https://docs.google.com/a/chef.io/document/d/1oJB0vZb_3bl7_ZU2YMDBkMFdL-EWplW1BJv_FXTUOzg/edit).\r\n\r\nRequirements\r\n------------\r\n- Chef 11 or higher\r\n- **Ruby 1.9.3 or higher**\r\n\r\nAttributes\r\n----------\r\nIn order to keep the README managable and in sync with the attributes, this cookbook documents attributes inline. The usage instructions and default values for attributes can be found in the individual attribute files.\r\n\r\nExamples\r\n---------\r\nDocumentation and examples are provided inline using YARD.  The tests and fixture cookbooks in `tests` and `tests/fixtures` are intended to be a further source of examples.\r\n\r\nRecipes\r\n-------\r\n### master\r\nThe master recipe will create the required directory structure and install jenkins. There are two installation methods, controlled by the `node['jenkins']['master']['install_method']` attribute:\r\n\r\n- `package` - Install Jenkins from the official jenkins-ci.org packages\r\n- `war` - Download the latest version of the WAR file and configure it with Runit\r\n\r\n### java\r\nBy default, this cookbook does not install, manage, or manipulate a JDK, as that is outside of the scope of Jenkins. The `package` installation method will automatically pull in a valid Java if one does not exist, by the nature of package installers. However, the `war` installation method will require you to install a valid Java runtime. This very simple recipe installs OpenJDK 7 on the target system. **If you need a more complex Java setup, you should use the community cookbook or write your own.** For more information and warnings, please see the inline documentation in the `jenkins::java` recipe.\r\n\r\nThis pattern is not unique. [RHEL Jenkins packages do not depend on a Java](https://wiki.jenkins-ci.org/display/JENKINS/Installing+Jenkins+on+RedHat+distributions), since there are so many derivatives to choose from.\r\n\r\n\r\nResource/Provider\r\n-----------------\r\n### jenkins_command\r\nThis resource executes arbitrary commands against the [Jenkins CLI](https://wiki.jenkins-ci.org/display/JENKINS/Jenkins+CLI), supporting the following actions:\r\n\r\n    :execute\r\n\r\n```ruby\r\njenkins_command 'safe-restart'\r\n```\r\n\r\nTo reload the configuration from disk:\r\n\r\n```ruby\r\njenkins_command 'reload-configuration'\r\n```\r\n\r\nTo prevent Jenkins from starting any new builds (in preparation for a shutdown):\r\n\r\n```ruby\r\njenkins_command 'quiet-down'\r\n```\r\n\r\n**NOTE** You must add your own `not_if`/`only_if` guards to the `jenkins_command` to prevent duplicate commands from executing. Just like Chef's core `execute` resource, the `jenkins_command` resource has no way of being idempotent.\r\n\r\n### jenkins_script\r\nThis resource executes arbitrary Java or Groovy commands against the Jenkins master. By the nature of this command, it is **not** idempotent.\r\n\r\n```ruby\r\njenkins_script 'println(\"This is Groovy code!\")'\r\n```\r\n\r\n```ruby\r\njenkins_script 'add_authentication' do\r\n  command <<-EOH.gsub(/^ {4}/, '')\r\n    import jenkins.model.*\r\n    import hudson.security.*\r\n    import org.jenkinsci.plugins.*\r\n\r\n    def instance = Jenkins.getInstance()\r\n\r\n    def githubRealm = new GithubSecurityRealm(\r\n      'https://github.com',\r\n      'https://api.github.com',\r\n      'API_KEY',\r\n      'API_SECRET'\r\n    )\r\n    instance.setSecurityRealm(githubRealm)\r\n\r\n    def strategy = new FullControlOnceLoggedInAuthorizationStrategy()\r\n    instance.setAuthorizationStrategy(strategy)\r\n\r\n    instance.save()\r\n  EOH\r\nend\r\n```\r\n\r\n### jenkins_credentials\r\n**NOTE** The use of the Jenkins credentials resource requries the Jenkins credentials plugin. This plugin began shipping with Jenkins 1.536. On older Jenkins installations, you will need to install the credentials plugin at version 1.6 or higher to utilize this resource. On newer versions of Jenkins, this resource should work correctly.\r\n\r\nEach credential can be referenced in job by its unique ID.\r\nYou can set this ID when creating credential, and set the same ID in job configuration.\r\nTo generate a unique ID, you can use linux command `uuidgen`.\r\n\r\n\r\nThis resource manages Jenkins credentials, supporting the following actions:\r\n\r\n    :create, :delete\r\n\r\nThe following type of credentials are supported:\r\n\r\n* __Password__ - Basic username + password credentials.\r\n* __Private Key__ - Credentials that use a username + private key (optionally protected with a passphrase).\r\n\r\nThe `jenkins_credentials` resource is actually the base resource for several resources that map directly back to a credentials type:\r\n\r\n* `jenkins_password_credentials`\r\n* `jenkins_private_key_credentials`\r\n\r\nThis uses the Jenkins Groovy API to create/delete credentials. It also supports whyrun mode.\r\n\r\nThe `:create` action idempotently creates a set of Jenkins credentials on the current node. The `username` attribute (also the name attribute) corresponds to the username of the credentials on the target node. You may also specify a `description` which is useful in credential identification.\r\n\r\n```ruby\r\n# Create password credentials\r\njenkins_password_credentials 'wcoyote' do\r\n  id 'f2361e6b-b8e0-4b2b-890b-82e85bc1a59f'\r\n  description 'Wile E Coyote'\r\n  password    'beepbeep'\r\nend\r\n\r\n# Create private key credentials\r\njenkins_private_key_credentials 'wcoyote' do\r\n  id 'fa3aab48-4edc-446d-b1e2-1d89d86f4458'\r\n  description 'Wile E Coyote'\r\n  private_key \"-----BEGIN RSA PRIVATE KEY-----\\nMIIEpAIBAAKCAQ...\"\r\nend\r\n\r\n# Private keys with a passphrase will also work\r\njenkins_private_key_credentials 'wcoyote' do\r\n  description 'Eile E Coyote'\r\n  private_key \"-----BEGIN RSA PRIVATE KEY-----\\nMIIEpAIBAAKCAQ...\"\r\n  passphrase  'beepbeep'\r\nend\r\n```\r\n\r\nThe `:delete` action idempotently removes a set of Jenkins credentials from the system. You can use the base `jenkins_credentials` resource or any of its children to perform the deletion.\r\n\r\n```ruby\r\njenkins_credentials 'wcoyote' do\r\n  action :delete\r\nend\r\n\r\njenkins_private_key_credentials 'wcoyote' do\r\n  action :delete\r\nend\r\n```\r\n\r\n**NOTE** Credentials in Jenkins can be created with 2 different \"scopes\" which determines where the credentials can be used:\r\n\r\n* __GLOBAL__ - This credential is available to the object on which the credential is associated and all objects that are children of that object. Typically you would use global-scoped credentials for things that are needed by jobs.\r\n* __SYSTEM__ - This credential is only available to the object on which the credential is associated. Typically you would use system-scoped credentials for things like email auth, slave connection, etc, i.e. where the Jenkins instance itself is using the credential. Unlike the global scope, this significantly restricts where the credential can be used, thereby providing a higher degree of confidentiality to the credential.\r\n\r\nThe credentials created with the `jenkins_credentials` are assigned a `GLOBAL` scope.\r\n\r\n### jenkins_job\r\nThis resource manages Jenkins jobs, supporting the following actions:\r\n\r\n    :create, :delete, :disable, :enable\r\n\r\nThe resource is fully idempotent and convergent. It also supports whyrun mode.\r\n\r\nThe `:create` action requires a Jenkins job `config.xml`. This config file must exist on the target node and contain a valid Jenkins job configuration file. Because the Jenkins CLI actually reads and generates its own copy of this file, **do NOT** write this configuration inside of the Jenkins job. We recommend putting them in Chef's file cache path:\r\n\r\n```ruby\r\nxml = File.join(Chef::Config[:file_cache_path], 'bacon-config.xml')\r\n\r\n# You could also use a `cookbook_file` or pure `file` resource to generate\r\n# content at this path.\r\ntemplate xml do\r\n  source 'custom-config.xml.erb'\r\nend\r\n\r\n# Create a jenkins job (default action is `:create`)\r\njenkins_job 'bacon' do\r\n  config xml\r\nend\r\n```\r\n\r\n```ruby\r\njenkins_job 'bacon' do\r\n  action :delete\r\nend\r\n```\r\n\r\nYou can disable a Jenkins job by specifying the `:disable` option. This will disable an existing job, if and only if that job exists and is enabled. If the job does not exist, an exception is raised.\r\n\r\n```ruby\r\njenkins_job 'bacon' do\r\n  action :disable\r\nend\r\n```\r\n\r\nYou can enable a Jenkins job by specifying the `:enable` option. This will enable an existing job, if and only if that job exists and is disabled. If the job does not exist, an exception is raised.\r\n\r\n```ruby\r\njenkins_job 'bacon' do\r\n  action :enable\r\nend\r\n```\r\n\r\n### jenkins_plugin\r\nThis resource manages Jenkins plugins, supporting the following actions:\r\n\r\n    :install, :uninstall, :enable, :disable\r\n\r\nThis uses the Jenkins CLI to install plugins. By default, it does a cold deploy, meaning the plugin is installed while Jenkins is still running. Some plugins may require you restart the Jenkins instance for their changed to take affect.\r\n\r\n- **A plugin's dependencies are also installed by default, this behavior can be disabled by setting the `install_deps` attribute to `false`.**\r\n- **This resource does not install plugin dependencies from a a given hpi/jpi URL - you must specify all plugin dependencies or Jenkins may not startup correctly!**\r\n\r\nThe `:install` action idempotently installs a Jenkins plugin on the current node. The name attribute corresponds to the name of the plugin on the Jenkins Update Center. You can also specify a particular version of the plugin to install. Finally, you can specify a full source URL or local path (on the node) to a plugin.\r\n\r\n```ruby\r\n# Install the latest version of the greenballs plugin\r\njenkins_plugin 'greenballs'\r\n\r\n# Install version 1.3 of the greenballs plugin\r\njenkins_plugin 'greenballs' do\r\n  version '1.3'\r\nend\r\n\r\n# Install a plugin from a given hpi (or jpi)\r\njenkins_plugin 'greenballs' do\r\n  source 'http://updates.jenkins-ci.org/download/plugins/greenballs/1.10/greenballs.hpi'\r\nend\r\n\r\n# Don't install a plugins dependencies\r\njenkins_plugin 'github-oauth' do\r\n  install_deps false\r\nend\r\n```\r\n\r\nDepending on the plugin, you may need to restart the Jenkins instance for the plugin to take affect:\r\n\r\nPackage installation method:\r\n```ruby\r\njenkins_plugin 'a_complicated_plugin' do\r\n  notifies :restart, 'service[jenkins]', :immediately\r\nend\r\n```\r\n\r\nWar installation method:\r\n```ruby\r\njenkins_plugin 'a_complicated_plugin' do\r\n  notifies :restart, 'runit_service[jenkins]', :immediately\r\nend\r\n```\r\n\r\n\r\nFor advanced users, this resource exposes an `options` attribute that will be passed to the installation command. For more information on the possible values of these options, pleaes consult the documentation for your Jenkins installation.\r\n\r\n```ruby\r\njenkins_plugin 'a_really_complicated_plugin' do\r\n  options '-deploy -cold'\r\nend\r\n```\r\n\r\nThe `:uninstall` action removes (uninstalls) a Jenkins plugin idempotently on the current node.\r\n\r\n```ruby\r\njenkins_plugin 'greenballs' do\r\n  action :uninstall\r\nend\r\n```\r\n\r\nThe `:enable` action enables a plugin. If the plugin is not installed, an exception is raised. If the plugin is already enabled, no action is taken.\r\n\r\n```ruby\r\njenkins_plugin 'greenballs' do\r\n  action :enable\r\nend\r\n```\r\n\r\nThe `:disable` action disables a plugin. If the plugin is not installed, an exception is raised. If the plugin is already disabled, no action is taken.\r\n\r\n```ruby\r\njenkins_plugin 'greenballs' do\r\n  action :disable\r\nend\r\n```\r\n\r\n**NOTE** You may need to restart Jenkins after changing a plugin. Because this varies on a case-by-case basis (and because everyone chooses to manage their Jenkins infrastructure differently) this LWRP does **NOT** restart Jenkins for you.\r\n\r\n### jenkins_slave\r\nThis resource manages Jenkins slaves, supporting the following actions:\r\n\r\n    :create, :delete, :connect, :disconnect, :online, :offline\r\n\r\nThe following slave launch methods are supported:\r\n\r\n* __JNLP/Java Web Start__ - Starts a slave by launching an agent program through JNLP. The launch in this case is initiated by the slave, thus slaves need not be IP reachable from the master (e.g. behind the firewall). This launch method is supported on *nix and Windows platforms.\r\n* __SSH__ - Jenkins has a built-in SSH client implementation that it can use to talk to remote `sshd` daemon and start a slave agent. This is the most convenient and preferred method for Unix slaves, which normally has `sshd` out-of-the-box.\r\n\r\nThe `jenkins_slave` resource is actually the base resource for several resources that map directly back to a launch method:\r\n\r\n* `jenkins_jnlp_slave` - As JNLP Slave connections are slave initiated, this resource should be part of a __slave__'s run list.\r\n* `jenkins_ssh_slave` - As SSH Slave connections are master initiated, this resource should be part of a __master__'s run list.\r\n\r\nThe `:create` action idempotently creates a Jenkins slave on the master. The name attribute corresponds to the name of the slave (which is also used to uniquely identify the slave).\r\n\r\n```ruby\r\n# Create a basic JNLP slave\r\njenkins_jnlp_slave 'builder' do\r\n  description 'A generic slave builder'\r\n  remote_fs   '/home/jenkins'\r\n  labels      ['builder', 'linux']\r\nend\r\n\r\n# Create a slave launched via SSH\r\njenkins_ssh_slave 'executor' do\r\n  description 'Run test suites'\r\n  remote_fs   '/share/executor'\r\n  labels      ['executor', 'freebsd', 'jail']\r\n\r\n  # SSH specific attributes\r\n  host        '172.11.12.53' # or 'slave.example.org'\r\n  user        'jenkins'\r\n  credentials 'wcoyote'\r\nend\r\n\r\n# A slave's executors, usage mode and availability can also be configured\r\njenkins_jnlp_slave 'smoke' do\r\n  description     'Runs a series of high-level smoke tests'\r\n  remote_fs       '/home/jenkins'\r\n  executors       5\r\n  usage_mode      'exclusive'\r\n  availability    'demand'\r\n  in_demand_delay 1\r\n  idle_delay      3\r\n  labels          ['runner', 'fast']\r\nend\r\n\r\n# Create a slave with a full environment\r\njenkins_jnlp_slave 'integration' do\r\n  description 'Runs the high-level integration suite'\r\n  remote_fs   '/home/jenkins'\r\n  labels      ['integration', 'rails', 'ruby']\r\n  environment(\r\n    RAILS_ENV: 'test',\r\n    GCC:       '1_000_000_000',\r\n  )\r\nend\r\n\r\n# Windows JNLP slave\r\njenkins_windows_slave 'mywinslave' do\r\n  remote_fs 'C:/jenkins'\r\n  user       '.\\Administrator'\r\n  password   'MyPassword'\r\nend\r\n```\r\n\r\nThe `:delete` action idempotently removes a slave from the cluster. Any services used to manage the underlying slave process will also be disabled.\r\n\r\n```ruby\r\njenkins_jnlp_slave 'builder' do\r\n  action :delete\r\nend\r\n\r\njenkins_ssh_slave 'executor' do\r\n  action :delete\r\nend\r\n```\r\n\r\nThe `:connect` action idempotently forces the master to reconnect to the specified slave. You can use the base `jenkins_slave` resource or any of its children to perform the connection.\r\n\r\n```ruby\r\njenkins_slave 'builder' do\r\n  action :connect\r\nend\r\n\r\njenkins_ssh_slave 'executor' do\r\n  action :connect\r\nend\r\n```\r\n\r\nThe `:disconnect` action idempotently forces the master to disconnect the specified slave. You can use the base `jenkins_slave` resource or any of its children to perform the connection.\r\n\r\n```ruby\r\njenkins_slave 'builder' do\r\n  action :disconnect\r\nend\r\n\r\njenkins_ssh_slave 'executor' do\r\n  action :disconnect\r\nend\r\n```\r\n\r\nThe `:online` action idempotently brings a slave back online. You can use the base `jenkins_slave` resource or any of its children to bring the slave online.\r\n\r\n```ruby\r\njenkins_slave 'builder' do\r\n  action :online\r\nend\r\n\r\njenkins_ssh_slave 'executor' do\r\n  action :online\r\nend\r\n```\r\n\r\nThe `:offline` action idempotently takes a slave temporarily offline. An optional reason for going offline can be provided with the `offline_reason` attribute. You can use the base `jenkins_slave` resource or any of its children to take a slave offline.\r\n\r\n```ruby\r\njenkins_slave 'builder' do\r\n  action :offline\r\nend\r\n\r\njenkins_ssh_slave 'executor' do\r\n  offline_reason 'ran out of energon'\r\n  action :offline\r\nend\r\n```\r\n\r\n**NOTE** It's worth noting the somewhat confusing differences between _disconnecting_ and _off-lining_ a slave:\r\n\r\n* __Disconnect__ - Instantly closes the channel of communication between the master and slave. Currently executing jobs will be terminated immediately. If a slave is configured with an availability of `always` the master will attempt to reconnect to the slave.\r\n* __Offline__ - Keeps the channel of communication between the master and slave open. Currently executing jobs will be allowed to finish, but no new jobs will be scheduled on the slave.\r\n\r\n### jenkins_user\r\nThis resource manages Jenkins users, supporting the following actions:\r\n\r\n    :create, :delete\r\n\r\nThis uses the Jenkins groovy API to create users.\r\n\r\nThe `:create` action idempotently creates a Jenkins user on the current node. The id attribute corresponds to the username of the id of the user on the target node. You may also specify a name, email, and list of SSH keys.\r\n\r\n```ruby\r\n# Create a Jenkins user\r\njenkins_user 'grumpy'\r\n\r\n# Create a Jenkins user with specific attributes\r\njenkins_user 'grumpy' do\r\n  full_name    'Grumpy Dwarf'\r\n  email        'grumpy@example.com'\r\n  public_keys  ['ssh-rsa AAAAB3NzaC1y...']\r\nend\r\n```\r\n\r\nThe `:delete` action removes a Jenkins user from the system.\r\n\r\n```ruby\r\njenkins_user 'grumpy' do\r\n  action :delete\r\nend\r\n```\r\n\r\n\r\nCaveats\r\n-------\r\n### Authentication\r\nIf you use or plan to use authentication for your Jenkins cluster (which we highly recommend), you will need to set a special value in the `run_context`:\r\n\r\n```ruby\r\nnode.run_state[:jenkins_private_key]\r\n```\r\n\r\nThe underlying executor class (which all HWRPs use) intelligently adds authentication information to the Jenkins CLI commands if this value is set. The method used to generate and populate this key-pair is left to the user:\r\n\r\n```ruby\r\n# Using search\r\nmaster = search(:node, 'fqdn:master.ci.example.com').first\r\nnode.run_state[:jenkins_private_key] = master['jenkins']['private_key']\r\n\r\n# Using encrypted data bags and chef-sugar\r\nprivate_key = encrypted_data_bag_item('jenkins', 'keys')['private_key']\r\nnode.run_state[:jenkins_private_key] = private_key\r\n```\r\n\r\nThe associated public key must be set on a Jenkins user. You can use the `jenkins_user` resource to create this pairing. Here's an example that loads a keypair and assigns it appropiately:\r\n\r\n```ruby\r\njenkins_keys = encrypted_data_bag_item('jenkins', 'keys')\r\n\r\nrequire 'openssl'\r\nrequire 'net/ssh'\r\n\r\nkey = OpenSSL::PKey::RSA.new(jenkins_keys['private_key'])\r\nprivate_key = key.to_pem\r\npublic_key = \"#{key.ssh_type} #{[key.to_blob].pack('m0')}\"\r\n\r\n# Create the Jenkins user with the public key\r\njenkins_user 'chef' do\r\n  public_keys [public_key]\r\nend\r\n\r\n# Set the private key on the Jenkins executor\r\nnode.run_state[:jenkins_private_key] = private_key\r\n```\r\n\r\nPlease note that older versions of Jenkins (< 1.555) permitted login via CLI for a user defined in Jenkins configuration with an SSH public key but not present in the actual SecurityRealm, and this is no longer permitted. If an operation requires any special permission at all, you must authenticate as a real user. This means that if you have LDAP or GitHub OAuth based authn/authz enabled the user you are using for configuraiton tasks must have an associated account in the external services. Please see [JENKINS-22346](https://issues.jenkins-ci.org/browse/JENKINS-22346) for more details.\r\n\r\nIf (and __only if__) you have your Jenkins instance configured to use the PAM (Unix user/group database) security realm you can set the\r\nusername and password the CLI uses via these two `run_context` values:\r\n\r\n```ruby\r\nnode.run_state[:jenkins_username]\r\nnode.run_state[:jenkins_password]\r\n```\r\n\r\n### Proxies\r\nIf you need to pass through a proxy to communicate between your masters and slaves, you will need to set a special node attribute:\r\n\r\n```ruby\r\nnode['jenkins']['executor']['proxy']\r\n```\r\n\r\nThe underlying executor class (which all HWRPs use) intelligently passes proxy information to the Jenkins CLI commands if this attribute is set. It should be set in the form `HOST:PORT`:\r\n\r\n```ruby\r\nnode.set['jenkins']['executor']['proxy'] = '1.2.3.4:5678'\r\n```\r\n\r\n\r\nDevelopment\r\n-----------\r\nPlease see the [Contributing](CONTRIBUTING.md) and [Issue Reporting](ISSUES.md) Guidelines.\r\n\r\n\r\nLicense & Authors\r\n-----------------\r\n- Author: Seth Vargo <sethvargo@gmail.com>\r\n- Author: Seth Chisamore <schisamo@chef.io>\r\n- Original Author: Doug MacEachern <dougm@vmware.com>\r\n- Contributor: AJ Christensen <aj@junglist.gen.nz>\r\n- Contributor: Fletcher Nichol <fnichol@nichol.ca>\r\n- Contributor: Roman Kamyk <rkj@go2.pl>\r\n- Contributor: Darko Fabijan <darko@renderedtext.com>\r\n\r\n```text\r\nCopyright 2010 VMware, Inc.\r\nCopyright 2011 Fletcher Nichol\r\nCopyright 2013-2014 Chef Software, Inc.\r\n\r\nLicensed under the Apache License, Version 2.0 (the \"License\");\r\nyou may not use this file except in compliance with the License.\r\nYou may obtain a copy of the License at\r\n\r\n    http://www.apache.org/licenses/LICENSE-2.0\r\n\r\nUnless required by applicable law or agreed to in writing, software\r\ndistributed under the License is distributed on an \"AS IS\" BASIS,\r\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\nSee the License for the specific language governing permissions and\r\nlimitations under the License.\r\n```\r\n","google":"","note":"Don't delete this file! It's used internally to help with page regeneration."}